<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia Dr. Mario Cota</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; text-align: center; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        
        /* HEADER */
        .header-logos { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 450px; margin-bottom: 20px; border-bottom: 2px solid #D4AF37; padding-bottom: 10px; }
        .logo-aguila { height: 65px; width: auto; } 
        .logo-vision { height: 50px; width: auto; } 
        
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,39,76,0.1); width: 100%; max-width: 380px; border-top: 5px solid #00274c; }
        
        h2 { color: #00274c; margin: 0 0 20px 0; font-weight: 800; font-size: 1.4rem; line-height: 1.3; }
        .subtitulo-dr { font-size: 1rem; color: #475569; font-weight: 600; display: block; margin-top: 5px; }
        
        label { font-size: 0.85rem; font-weight: bold; color: #475569; display: block; text-align: left; margin-bottom: 5px; }
        select { width: 100%; padding: 12px; border: 2px solid #00274c; background: #f8fafc; border-radius: 10px; margin-bottom: 15px; font-weight: bold; color: #00274c; outline: none; font-size: 0.9rem; }
        
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 12px; box-sizing: border-box; outline: none; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: #D4AF37; }

        /* GPS BOX */
        .status-box { padding: 12px; background: #f1f5f9; border-radius: 10px; border-left: 5px solid #cbd5e1; font-size: 0.9rem; color: #475569; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; text-align: left; }

        button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-locked { background: #94a3b8; cursor: not-allowed; }
        .btn-active { background: #00274c; box-shadow: 0 4px 15px rgba(0, 39, 76, 0.4); } 
        .btn-active:hover { background: #003a70; }

        /* BOT√ìN CLASSROOM (NUEVO) */
        .btn-classroom { background: #0f9d58; margin-top: 15px; box-shadow: 0 4px 10px rgba(15, 157, 88, 0.3); }
        .btn-classroom:hover { background: #0b8043; }

        .footer-logos { margin-top: 30px; display: flex; align-items: center; justify-content: center; gap: 15px; opacity: 0.9; }
        .logo-esef { height: 55px; width: auto; } 
        .logo-fefyde { height: 40px; width: auto; } 

        /* TICKET */
        #pantallaTicket { display: none; width: 100%; max-width: 380px; }
        .ticket { background: #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid #e2e8f0; overflow: hidden; position: relative; }
        .ticket-header { background: #00274c; color: #D4AF37; padding: 15px; text-transform: uppercase; font-weight: bold; font-size: 0.8rem; letter-spacing: 0.5px; }
        
        /* QR AREA - CORREGIDO PARA QUE SE VEA SIEMPRE */
        .qr-area { margin: 20px auto; display: flex; justify-content: center; padding: 10px; background: white; }
        
        .ticket-info { padding: 20px; text-align: left; border-top: 2px dashed #ddd; background: #fafafa; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .bloqueado-msg { background: #fee2e2; color: #b91c1c; padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-top: 10px; display:none; border: 1px solid #fca5a5; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .searching { animation: pulse 1.5s infinite; color: #D4AF37; font-weight: bold; }
    </style>
</head>
<body>

    <div id="pantallaFormulario">
        <div class="header-logos">
            <img src="1.png" alt="UAS" class="logo-aguila">
            <img src="2.jpg" alt="Visi√≥n 2029" class="logo-vision">
        </div>

        <div class="card">
            <h2>
                Registro de Asistencia
                <span class="subtitulo-dr">Dr. Mario Cota</span>
            </h2>
            
            <label>Selecciona tu Materia:</label>
            <select id="materiaSeleccionada" onchange="checkInputs()">
                <option value="" disabled selected>-- Elige una opci√≥n --</option>
                <option value="LED">BIOESTAD√çSTICA (Lic. Educ. Deportiva)</option>
                <option value="LAFS">ESTAD√çSTICA (Lic. Act. F√≠sica y Salud)</option>
            </select>

            <input type="text" id="nombre" placeholder="Apellidos y Nombre" onkeyup="checkInputs()">
            <input type="text" id="grupo" placeholder="Grupo (Ej: 3-B)" onkeyup="checkInputs()">

            <div class="status-box" id="gpsBox">
                <span id="gpsIcon">üì°</span>
                <span id="gpsMsg" class="searching">Sincronizando con el profesor...</span>
            </div>

            <button id="btnEnviar" class="btn-locked" disabled onclick="procesarAsistencia()">
                üîí COMPLETAR DATOS
            </button>
        </div>

        <div class="footer-logos">
            <img src="3.jpg" alt="ESEF" class="logo-esef">
            <img src="FEFYDE.png" alt="FEFyDE" class="logo-fefyde">
        </div>
    </div>

    <div id="pantallaTicket">
        <div class="ticket">
            <div class="ticket-header" id="ticketMateriaHeader">ASISTENCIA</div>
            
            <div class="qr-area" id="qrTicket"></div>
            
            <div id="ticketTitulo" style="color:#15803d; font-weight:bold; margin-bottom:5px;">‚úÖ Asistencia Guardada</div>
            <div style="font-size:0.8rem; color:#666; margin-bottom:15px;">Datos sincronizados</div>

            <div class="ticket-info">
                <div class="row"><span>Materia:</span><b id="tMateria">---</b></div>
                <div class="row"><span>Alumno:</span><b id="tNombre">---</b></div>
                <div class="row"><span>Grupo:</span><b id="tGrupo">---</b></div>
                <div class="row"><span>Fecha:</span><b id="tFecha">---</b></div>
            </div>
        </div>
        
        <div id="avisoBloqueo" class="bloqueado-msg">
            ‚è≥ Ya registraste asistencia hoy. Espera <span id="minutosRestantes"></span> minutos.
        </div>
        
        <p style="color:#666; font-size:0.8rem; margin-top:10px;">Toma captura de este ticket</p>

        <button class="btn-classroom" onclick="abrirClassroom()">
            üìÇ SUBIR A CLASSROOM
        </button>
    </div>

<script>
    // --- TU EXCEL ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxfgqo2akfpCvDjERD3XNuuoPopg4Vcqo7gBNffRI3iSmyGppCYzVf1ybEHYHor-KXT/exec";
    
    // --- CONFIGURACI√ìN ACTUALIZADA ---
    // Usamos 150m para ser tolerantes con los celulares "malos" pero seguros contra los de casa.
    const RADIO_METROS = 150; 
    const TIEMPO_ESPERA = 60; // 60 Minutos de bloqueo

    let latProfe = null, lonProfe = null, gpsValido = false;
    const params = new URLSearchParams(window.location.search);
    latProfe = parseFloat(params.get('lat'));
    lonProfe = parseFloat(params.get('lon'));

    const btn = document.getElementById('btnEnviar');
    const msg = document.getElementById('gpsMsg');
    const box = document.getElementById('gpsBox');

    window.onload = () => {
        verificarBloqueo(); 
        if(localStorage.getItem("bio_nombre")) document.getElementById("nombre").value = localStorage.getItem("bio_nombre");
        if(localStorage.getItem("bio_grupo")) document.getElementById("grupo").value = localStorage.getItem("bio_grupo");
        
        if(!latProfe) {
            msg.innerText = "‚ö†Ô∏è ERROR: Escanea el QR del maestro.";
            msg.classList.remove("searching");
            box.style.borderLeftColor = "#ef4444";
        } else {
            checkInputs();
        }
    };

    function verificarBloqueo() {
        const ultimoRegistro = localStorage.getItem("bio_ultimo_tiempo");
        if (ultimoRegistro) {
            const diferencia = (Date.now() - parseInt(ultimoRegistro)) / 1000 / 60;
            if (diferencia < TIEMPO_ESPERA) {
                mostrarPantallaBloqueo(diferencia);
                return true; 
            }
        }
        return false; 
    }

    function mostrarPantallaBloqueo(diferencia) {
        const nombre = localStorage.getItem("bio_nombre");
        const grupo = localStorage.getItem("bio_grupo");
        const fecha = localStorage.getItem("bio_fecha_ticket");
        const materia = localStorage.getItem("bio_materia_nombre");
        
        if(nombre && fecha) {
            generarTicket(nombre, grupo, fecha, materia || "Clase");
            document.getElementById("avisoBloqueo").style.display = "block";
            document.getElementById("minutosRestantes").innerText = Math.ceil(TIEMPO_ESPERA - diferencia);
            document.getElementById("ticketTitulo").innerText = "‚ö†Ô∏è Registro Anterior";
            document.getElementById("ticketTitulo").style.color = "#d97706";
        }
    }

    function checkInputs() {
        const nombre = document.getElementById("nombre").value;
        const grupo = document.getElementById("grupo").value;
        const materia = document.getElementById("materiaSeleccionada").value;
        
        if(nombre.length > 3 && grupo.length > 0 && materia !== "" && latProfe) {
            if(!gpsValido) iniciarGPS();
        }
    }

    // --- NUEVA L√ìGICA DE GPS "H√çBRIDO" ---
    function iniciarGPS() {
        if("geolocation" in navigator) {
            
            // INTENTO 1: ALTA PRECISI√ìN (SAT√âLITE)
            const opcionesAlta = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
            
            // INTENTO 2: BAJA PRECISI√ìN (WIFI/ANTENAS) - Para los cels que fallan
            const opcionesBaja = { enableHighAccuracy: false, timeout: 15000, maximumAge: 0 };

            // Primero probamos alta precisi√≥n
            navigator.geolocation.watchPosition(exitoGPS, (err) => {
                console.warn("Fallo GPS Alta Precisi√≥n, intentando Baja...", err);
                // Si falla, intentamos modo compatible
                navigator.geolocation.watchPosition(exitoGPS, errorGPS, opcionesBaja);
            }, opcionesAlta);

        } else {
            msg.innerText = "Tu celular no soporta Geolocalizaci√≥n.";
        }
    }

    function exitoGPS(pos) {
        const dist = getDistancia(latProfe, lonProfe, pos.coords.latitude, pos.coords.longitude);
        
        if(dist <= RADIO_METROS) {
            gpsValido = true;
            box.style.borderLeftColor = "#00274c";
            box.style.background = "#eef2ff";
            msg.innerText = "Ubicaci√≥n Validada Correctamente";
            msg.classList.remove("searching");
            msg.style.color = "#00274c";
            btn.disabled = false;
            btn.className = "btn-active";
            btn.innerHTML = "‚òÅÔ∏è GUARDAR ASISTENCIA";
        } else {
            gpsValido = false;
            msg.innerText = `Fuera del rango (${dist.toFixed(0)}m). Ac√©rcate.`;
            msg.classList.remove("searching");
            btn.disabled = true;
            btn.className = "btn-locked";
            btn.innerHTML = "üîí AC√âRCATE M√ÅS";
        }
    }

    function errorGPS(err) {
        // Mensajes inteligentes para el alumno
        if(err.code === 1) msg.innerText = "üö´ Permiso denegado. Act√≠valo en el candado üîí arriba.";
        else if(err.code === 2) msg.innerText = "üì° Sin se√±al GPS. Abre Google Maps primero.";
        else if(err.code === 3) msg.innerText = "‚è±Ô∏è Tiempo agotado. Recarga la p√°gina.";
        else msg.innerText = "‚ö†Ô∏è Error desconocido de ubicaci√≥n.";
        
        box.style.borderLeftColor = "#ef4444";
    }

    function getDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function procesarAsistencia() {
        if (verificarBloqueo()) {
            alert("‚ö†Ô∏è ¬°ERROR! Ya registraste asistencia hoy.");
            location.reload(); 
            return;
        }

        const nombre = document.getElementById("nombre").value;
        const grupo = document.getElementById("grupo").value;
        const selectMateria = document.getElementById("materiaSeleccionada");
        const materiaCodigo = selectMateria.value;
        const materiaTexto = selectMateria.options[selectMateria.selectedIndex].text;

        const ahora = new Date();
        const fechaTxt = ahora.toLocaleDateString('es-MX', {day:'numeric', month:'short'});
        const horaTxt = ahora.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
        
        localStorage.setItem("bio_nombre", nombre);
        localStorage.setItem("bio_grupo", grupo);
        localStorage.setItem("bio_materia_nombre", materiaTexto);
        localStorage.setItem("bio_ultimo_tiempo", Date.now()); 
        localStorage.setItem("bio_fecha_ticket", `${fechaTxt} - ${horaTxt}`);

        btn.innerHTML = "‚è≥ Guardando...";
        btn.disabled = true;

        const datos = { 
            nombre: nombre, 
            grupo: grupo, 
            hora: horaTxt, 
            materia: materiaCodigo 
        };
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        })
        .then(() => {
            generarTicket(nombre, grupo, `${fechaTxt} - ${horaTxt}`, materiaTexto);
        })
        .catch(error => {
            generarTicket(nombre, grupo, `${fechaTxt} - ${horaTxt}`, materiaTexto);
        });
    }

    function generarTicket(nombre, grupo, fechaHora, materiaNombre) {
        document.getElementById("pantallaFormulario").style.display = "none";
        document.getElementById("pantallaTicket").style.display = "block";
        
        document.getElementById("tNombre").innerText = nombre;
        document.getElementById("tGrupo").innerText = grupo;
        document.getElementById("tFecha").innerText = fechaHora;
        document.getElementById("tMateria").innerText = materiaNombre; 
        document.getElementById("ticketMateriaHeader").innerText = materiaNombre;

        // Limpiar y Generar QR
        const qrContainer = document.getElementById("qrTicket");
        qrContainer.innerHTML = "";
        
        // Esperamos un microsegundo para que el div sea visible antes de pintar
        setTimeout(() => {
            new QRCode(qrContainer, {
                text: `UAS|${materiaNombre}|${nombre}|${fechaHora}`,
                width: 160, height: 160,
                colorDark : "#00274c",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }, 100);
    }

    function abrirClassroom() {
        // Enlace universal a Classroom
        window.open("https://classroom.google.com/", "_blank");
    }
</script>

</body>
</html>
