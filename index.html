<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia Dr. Mario Cota</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; text-align: center; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        
        /* CABECERA */
        .header-logos { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 450px; margin-bottom: 20px; border-bottom: 2px solid #D4AF37; padding-bottom: 10px; }
        .logo-aguila { height: 65px; width: auto; } 
        .logo-vision { height: 50px; width: auto; } 
        
        /* TARJETA */
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,39,76,0.1); width: 100%; max-width: 380px; border-top: 5px solid #00274c; }
        
        /* T√çTULO PERSONALIZADO */
        h2 { color: #00274c; margin: 0 0 20px 0; font-weight: 800; font-size: 1.4rem; line-height: 1.3; }
        .subtitulo-dr { font-size: 1rem; color: #475569; font-weight: 600; display: block; margin-top: 5px; }
        
        /* INPUTS Y SELECT */
        label { font-size: 0.85rem; font-weight: bold; color: #475569; display: block; text-align: left; margin-bottom: 5px; }
        select { width: 100%; padding: 12px; border: 2px solid #00274c; background: #f8fafc; border-radius: 10px; margin-bottom: 15px; font-weight: bold; color: #00274c; outline: none; font-size: 0.9rem; }
        
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 12px; box-sizing: border-box; outline: none; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: #D4AF37; }

        /* GPS BOX */
        .status-box { padding: 12px; background: #f1f5f9; border-radius: 10px; border-left: 5px solid #cbd5e1; font-size: 0.9rem; color: #475569; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; text-align: left; }

        /* BOTONES */
        button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-locked { background: #94a3b8; cursor: not-allowed; }
        .btn-active { background: #00274c; box-shadow: 0 4px 15px rgba(0, 39, 76, 0.4); } 
        .btn-active:hover { background: #003a70; }

        /* FOOTER */
        .footer-logos { margin-top: 30px; display: flex; align-items: center; justify-content: center; gap: 15px; opacity: 0.9; }
        .logo-esef { height: 55px; width: auto; } 
        .logo-fefyde { height: 40px; width: auto; } 

        /* TICKET */
        #pantallaTicket { display: none; width: 100%; max-width: 380px; }
        .ticket { background: #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid #e2e8f0; overflow: hidden; position: relative; }
        .ticket-header { background: #00274c; color: #D4AF37; padding: 15px; text-transform: uppercase; font-weight: bold; font-size: 0.8rem; letter-spacing: 0.5px; }
        .qr-area { margin: 20px auto; display: flex; justify-content: center; }
        .ticket-info { padding: 20px; text-align: left; border-top: 2px dashed #ddd; background: #fafafa; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .bloqueado-msg { background: #fee2e2; color: #b91c1c; padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-top: 10px; display:none; border: 1px solid #fca5a5; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .searching { animation: pulse 1.5s infinite; color: #D4AF37; font-weight: bold; }
    </style>
</head>
<body>

    <div id="pantallaFormulario">
        <div class="header-logos">
            <img src="1.png" alt="UAS" class="logo-aguila">
            <img src="2.jpg" alt="Visi√≥n 2029" class="logo-vision">
        </div>

        <div class="card">
            <h2>
                Registro de Asistencia
                <span class="subtitulo-dr">Dr. Mario Cota</span>
            </h2>
            
            <label>Selecciona tu Materia:</label>
            <select id="materiaSeleccionada" onchange="checkInputs()">
                <option value="" disabled selected>-- Elige una opci√≥n --</option>
                <option value="LED">BIOESTAD√çSTICA (Lic. Educ. Deportiva)</option>
                <option value="LAFS">ESTAD√çSTICA (Lic. Act. F√≠sica y Salud)</option>
            </select>

            <input type="text" id="nombre" placeholder="Apellidos y Nombre" onkeyup="checkInputs()">
            <input type="text" id="grupo" placeholder="Grupo (Ej: 3-B)" onkeyup="checkInputs()">

            <div class="status-box" id="gpsBox">
                <span id="gpsIcon">üì°</span>
                <span id="gpsMsg" class="searching">Sincronizando con el profesor...</span>
            </div>

            <button id="btnEnviar" class="btn-locked" disabled onclick="procesarAsistencia()">
                üîí COMPLETAR DATOS
            </button>
        </div>

        <div class="footer-logos">
            <img src="3.jpg" alt="ESEF" class="logo-esef">
            <img src="FEFYDE.png" alt="FEFyDE" class="logo-fefyde">
        </div>
    </div>

    <div id="pantallaTicket">
        <div class="ticket">
            <div class="ticket-header" id="ticketMateriaHeader">ASISTENCIA</div>
            
            <div class="qr-area" id="qrTicket"></div>
            
            <div id="ticketTitulo" style="color:#15803d; font-weight:bold; margin-bottom:5px;">‚úÖ Asistencia Guardada</div>
            <div style="font-size:0.8rem; color:#666; margin-bottom:15px;">Datos sincronizados</div>

            <div class="ticket-info">
                <div class="row"><span>Materia:</span><b id="tMateria">---</b></div>
                <div class="row"><span>Alumno:</span><b id="tNombre">---</b></div>
                <div class="row"><span>Grupo:</span><b id="tGrupo">---</b></div>
                <div class="row"><span>Fecha:</span><b id="tFecha">---</b></div>
            </div>
        </div>
        
        <div id="avisoBloqueo" class="bloqueado-msg">
            ‚è≥ Ya registraste asistencia hoy. Espera <span id="minutosRestantes"></span> minutos para volver a registrar.
        </div>

        <p style="color:#666; font-size:0.8rem; margin-top:15px;">Captura este ticket como tu comprobante.</p>
    </div>

<script>
    // --- LINK DE EXCEL ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxfgqo2akfpCvDjERD3XNuuoPopg4Vcqo7gBNffRI3iSmyGppCYzVf1ybEHYHor-KXT/exec";
    
    // CONFIGURACI√ìN (AQU√ç EST√Å EL CAMBIO)
    const RADIO_METROS = 30; // ‚ö†Ô∏è AHORA EST√Å EN 30 METROS
    const TIEMPO_ESPERA = 90; // Minutos de bloqueo entre registros

    // Variables internas
    let latProfe = null, lonProfe = null, gpsValido = false;
    const params = new URLSearchParams(window.location.search);
    latProfe = parseFloat(params.get('lat'));
    lonProfe = parseFloat(params.get('lon'));

    const btn = document.getElementById('btnEnviar');
    const msg = document.getElementById('gpsMsg');
    const box = document.getElementById('gpsBox');

    window.onload = () => {
        verificarBloqueo(); // Revisar si ya chec√≥
        
        // Cargar datos previos
        if(localStorage.getItem("bio_nombre")) document.getElementById("nombre").value = localStorage.getItem("bio_nombre");
        if(localStorage.getItem("bio_grupo")) document.getElementById("grupo").value = localStorage.getItem("bio_grupo");
        
        if(!latProfe) {
            msg.innerText = "‚ö†Ô∏è ERROR: Escanea el QR del maestro.";
            msg.classList.remove("searching");
            box.style.borderLeftColor = "#ef4444";
        } else {
            checkInputs();
        }
    };

    function verificarBloqueo() {
        const ultimoRegistro = localStorage.getItem("bio_ultimo_tiempo");
        if (ultimoRegistro) {
            const diferencia = (Date.now() - parseInt(ultimoRegistro)) / 1000 / 60;
            if (diferencia < TIEMPO_ESPERA) {
                // Recuperar datos para mostrar ticket antiguo
                const nombre = localStorage.getItem("bio_nombre");
                const grupo = localStorage.getItem("bio_grupo");
                const fecha = localStorage.getItem("bio_fecha_ticket");
                const materia = localStorage.getItem("bio_materia_nombre");
                
                if(nombre && fecha) {
                    generarTicket(nombre, grupo, fecha, materia || "Clase", true);
                    document.getElementById("avisoBloqueo").style.display = "block";
                    document.getElementById("minutosRestantes").innerText = Math.ceil(TIEMPO_ESPERA - diferencia);
                    document.getElementById("ticketTitulo").innerText = "‚ö†Ô∏è Registro Anterior";
                    document.getElementById("ticketTitulo").style.color = "#d97706";
                }
            }
        }
    }

    function checkInputs() {
        const nombre = document.getElementById("nombre").value;
        const grupo = document.getElementById("grupo").value;
        const materia = document.getElementById("materiaSeleccionada").value;
        
        if(nombre.length > 3 && grupo.length > 0 && materia !== "" && latProfe) {
            if(!gpsValido) iniciarGPS();
        }
    }

    function iniciarGPS() {
        if("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                const dist = getDistancia(latProfe, lonProfe, pos.coords.latitude, pos.coords.longitude);
                if(dist <= RADIO_METROS) {
                    gpsValido = true;
                    box.style.borderLeftColor = "#00274c";
                    box.style.background = "#eef2ff";
                    msg.innerText = "Ubicaci√≥n Validada Correctamente";
                    msg.classList.remove("searching");
                    msg.style.color = "#00274c";
                    btn.disabled = false;
                    btn.className = "btn-active";
                    btn.innerHTML = "‚òÅÔ∏è GUARDAR ASISTENCIA";
                } else {
                    gpsValido = false;
                    msg.innerText = `Fuera del rango (${dist.toFixed(0)}m)`;
                    msg.classList.remove("searching");
                    btn.disabled = true;
                    btn.className = "btn-locked";
                    btn.innerHTML = "üîí AC√âRCATE M√ÅS";
                }
            }, null, { enableHighAccuracy: true });
        }
    }

    function getDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function procesarAsistencia() {
        const nombre = document.getElementById("nombre").value;
        const grupo = document.getElementById("grupo").value;
        
        // Obtener datos de materia
        const selectMateria = document.getElementById("materiaSeleccionada");
        const materiaCodigo = selectMateria.value; // LED o LAFS
        const materiaTexto = selectMateria.options[selectMateria.selectedIndex].text;

        const ahora = new Date();
        const fechaTxt = ahora.toLocaleDateString('es-MX', {day:'numeric', month:'short'});
        const horaTxt = ahora.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
        
        // Guardar candado
        localStorage.setItem("bio_nombre", nombre);
        localStorage.setItem("bio_grupo", grupo);
        localStorage.setItem("bio_materia_nombre", materiaTexto);
        localStorage.setItem("bio_ultimo_tiempo", Date.now());
        localStorage.setItem("bio_fecha_ticket", `${fechaTxt} - ${horaTxt}`);

        btn.innerHTML = "‚è≥ Guardando...";
        btn.disabled = true;

        // ENVIAR A EXCEL
        const datos = { 
            nombre: nombre, 
            grupo: grupo, 
            hora: horaTxt, 
            materia: materiaCodigo // Importante: Env√≠a "LED" o "LAFS"
        };
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        })
        .then(() => {
            generarTicket(nombre, grupo, `${fechaTxt} - ${horaTxt}`, materiaTexto, false);
        })
        .catch(error => {
            generarTicket(nombre, grupo, `${fechaTxt} - ${horaTxt}`, materiaTexto, false);
        });
    }

    function generarTicket(nombre, grupo, fechaHora, materiaNombre, esModoVista) {
        document.getElementById("pantallaFormulario").style.display = "none";
        document.getElementById("pantallaTicket").style.display = "block";
        
        document.getElementById("tNombre").innerText = nombre;
        document.getElementById("tGrupo").innerText = grupo;
        document.getElementById("tFecha").innerText = fechaHora;
        document.getElementById("tMateria").innerText = materiaNombre; 
        
        // Encabezado del Ticket
        document.getElementById("ticketMateriaHeader").innerText = materiaNombre;

        document.getElementById("qrTicket").innerHTML = "";
        new QRCode(document.getElementById("qrTicket"), {
            text: `VALIDADO|${materiaNombre}|${nombre}|${fechaHora}`,
            width: 150, height: 150,
            colorDark : "#00274c",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    }
</script>

</body>
</html>


