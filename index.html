<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia Dr. MArio Cota</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; text-align: center; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        
        .header-logos { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 450px; margin-bottom: 20px; border-bottom: 2px solid #D4AF37; padding-bottom: 10px; }
        .logo-aguila { height: 65px; width: auto; } 
        .logo-vision { height: 50px; width: auto; } 
        
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,39,76,0.1); width: 100%; max-width: 380px; border-top: 5px solid #00274c; }
        
        h2 { color: #00274c; margin: 0 0 20px 0; font-weight: 800; font-size: 1.5rem; }
        
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 12px; box-sizing: border-box; outline: none; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: #D4AF37; }

        .status-box { padding: 12px; background: #f1f5f9; border-radius: 10px; border-left: 5px solid #cbd5e1; font-size: 0.9rem; color: #475569; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; text-align: left; }

        button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-locked { background: #94a3b8; cursor: not-allowed; }
        .btn-active { background: #00274c; box-shadow: 0 4px 15px rgba(0, 39, 76, 0.4); } 
        .btn-active:hover { background: #003a70; }

        .footer-logos { margin-top: 30px; display: flex; align-items: center; justify-content: center; gap: 15px; opacity: 0.9; }
        .logo-esef { height: 55px; width: auto; } 
        .logo-fefyde { height: 40px; width: auto; } 

        #pantallaTicket { display: none; width: 100%; max-width: 380px; }
        .ticket { background: #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid #e2e8f0; overflow: hidden; position: relative; }
        .ticket-header { background: #00274c; color: #D4AF37; padding: 15px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .qr-area { margin: 20px auto; display: flex; justify-content: center; }
        .ticket-info { padding: 20px; text-align: left; border-top: 2px dashed #ddd; background: #fafafa; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .bloqueado-msg { background: #fee2e2; color: #b91c1c; padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-top: 10px; display:none; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .searching { animation: pulse 1.5s infinite; color: #D4AF37; font-weight: bold; }
    </style>
</head>
<body>

    <div id="pantallaFormulario">
        <div class="header-logos">
            <img src="1.png" alt="UAS" class="logo-aguila">
            <img src="2.jpg" alt="Visi√≥n 2029" class="logo-vision">
        </div>

        <div class="card">
            <h2>Asistencia Profesor Mario Cota</h2>
            
            <input type="text" id="nombre" placeholder="Apellidos y Nombre" onkeyup="checkInputs()">
            <input type="text" id="grupo" placeholder="Grupo (Ej: 3-B)" onkeyup="checkInputs()">

            <div class="status-box" id="gpsBox">
                <span id="gpsIcon">üì°</span>
                <span id="gpsMsg" class="searching">Sincronizando con el profesor...</span>
            </div>

            <button id="btnEnviar" class="btn-locked" disabled onclick="procesarAsistencia()">
                üîí COMPLETAR DATOS
            </button>
        </div>

        <div class="footer-logos">
            <img src="3.jpg" alt="ESEF" class="logo-esef">
            <img src="FEFYDE.png" alt="FEFyDE" class="logo-fefyde">
        </div>
    </div>

    <div id="pantallaTicket">
        <div class="ticket">
            <div class="ticket-header">Pase de Lista Oficial</div>
            
            <div class="qr-area" id="qrTicket"></div>
            
            <div id="ticketTitulo" style="color:#15803d; font-weight:bold; margin-bottom:5px;">‚úÖ Asistencia Guardada</div>
            <div style="font-size:0.8rem; color:#666; margin-bottom:15px;">Datos sincronizados</div>

            <div class="ticket-info">
                <div class="row"><span>Alumno:</span><b id="tNombre">---</b></div>
                <div class="row"><span>Grupo:</span><b id="tGrupo">---</b></div>
                <div class="row"><span>Fecha:</span><b id="tFecha">---</b></div>
                <div class="row"><span>ID:</span><b id="tID" style="color:#D4AF37">---</b></div>
            </div>
        </div>
        
        <div id="avisoBloqueo" class="bloqueado-msg">
            ‚è≥ Tu dispositivo ya registr√≥ asistencia hoy. Podr√°s registrarte de nuevo en <span id="minutosRestantes"></span> minutos.
        </div>

        <p style="color:#666; font-size:0.8rem; margin-top:15px;">Captura este ticket como tu comprobante.</p>
    </div>

<script>
    // --- ‚ö†Ô∏è TU LINK GOOGLE SCRIPT ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzAh9umOgf_cpm8x3IC0h-8DEw-xdNjD_PXbbA6MF46FJlyVLrooqWG9ooqoMRn36U7/exec";
    
    const RADIO_METROS =60; 
    const TIEMPO_ESPERA = 90; // Minutos que deben esperar para volver a registrar

    // Variables internas
    let latProfe = null, lonProfe = null, gpsValido = false;
    const params = new URLSearchParams(window.location.search);
    latProfe = parseFloat(params.get('lat'));
    lonProfe = parseFloat(params.get('lon'));

    const btn = document.getElementById('btnEnviar');
    const msg = document.getElementById('gpsMsg');
    const box = document.getElementById('gpsBox');

    window.onload = () => {
        // 1. VERIFICAR SI YA REGISTR√ì ASISTENCIA HOY
        verificarBloqueo();

        // 2. Cargar datos si no est√° bloqueado
        if(localStorage.getItem("bio_nombre")) document.getElementById("nombre").value = localStorage.getItem("bio_nombre");
        if(localStorage.getItem("bio_grupo")) document.getElementById("grupo").value = localStorage.getItem("bio_grupo");
        
        if(!latProfe) {
            msg.innerText = "‚ö†Ô∏è ERROR: Debes escanear el QR del maestro.";
            msg.classList.remove("searching");
            box.style.borderLeftColor = "#ef4444";
        } else {
            checkInputs();
        }
    };

    function verificarBloqueo() {
        const ultimoRegistro = localStorage.getItem("bio_ultimo_tiempo");
        
        if (ultimoRegistro) {
            const ahora = Date.now();
            const diferenciaMinutos = (ahora - parseInt(ultimoRegistro)) / 1000 / 60;
            
            if (diferenciaMinutos < TIEMPO_ESPERA) {
                // EST√Å BLOQUEADO: Mostrar ticket anterior directamente
                const nombreGuardado = localStorage.getItem("bio_nombre");
                const grupoGuardado = localStorage.getItem("bio_grupo");
                const fechaGuardada = localStorage.getItem("bio_fecha_ticket");
                
                if(nombreGuardado && fechaGuardada) {
                    generarTicket(nombreGuardado, grupoGuardado, fechaGuardada, "", true); // true = modo vista
                    
                    // Mostrar aviso de bloqueo
                    document.getElementById("avisoBloqueo").style.display = "block";
                    document.getElementById("minutosRestantes").innerText = Math.ceil(TIEMPO_ESPERA - diferenciaMinutos);
                    document.getElementById("ticketTitulo").innerText = "‚ö†Ô∏è Registro Anterior";
                    document.getElementById("ticketTitulo").style.color = "#d97706"; // Naranja
                }
            }
        }
    }

    function checkInputs() {
        const nombre = document.getElementById("nombre").value;
        const grupo = document.getElementById("grupo").value;
        // Solo iniciamos GPS si no est√° bloqueado (aunque la vista ticket lo tapa)
        if(nombre.length > 3 && grupo.length > 0 && latProfe) {
            if(!gpsValido) iniciarGPS();
        }
    }

    function iniciarGPS() {
        if("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                const dist = getDistancia(latProfe, lonProfe, pos.coords.latitude, pos.coords.longitude);
                if(dist <= RADIO_METROS) {
                    gpsValido = true;
                    box.style.borderLeftColor = "#00274c";
                    box.style.background = "#eef2ff";
                    msg.innerText = "Ubicaci√≥n Validada Correctamente";
                    msg.classList.remove("searching");
                    msg.style.color = "#00274c";
                    
                    btn.disabled = false;
                    btn.className = "btn-active";
                    btn.innerHTML = "‚òÅÔ∏è GUARDAR ASISTENCIA";
                } else {
                    gpsValido = false;
                    msg.innerText = `Fuera del rango (${dist.toFixed(0)}m)`;
                    msg.classList.remove("searching");
                    msg.style.color = "#ef4444";
                    btn.disabled = true;
                    btn.className = "btn-locked";
                    btn.innerHTML = "üîí AC√âRCATE M√ÅS";
                }
            }, null, { enableHighAccuracy: true });
        }
    }

    function getDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function procesarAsistencia() {
        // Doble verificaci√≥n por si hackearon el HTML
        const ultimoRegistro = localStorage.getItem("bio_ultimo_tiempo");
        if (ultimoRegistro) {
            const diff = (Date.now() - parseInt(ultimoRegistro)) / 1000 / 60;
            if (diff < TIEMPO_ESPERA) {
                alert("Ya registraste asistencia. Espera " + Math.ceil(TIEMPO_ESPERA - diff) + " minutos.");
                location.reload();
                return;
            }
        }

        const nombre = document.getElementById("nombre").value;
        const grupo = document.getElementById("grupo").value;
        const ahora = new Date();
        const fechaTxt = ahora.toLocaleDateString('es-MX', {day:'numeric', month:'short'});
        const horaTxt = ahora.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
        
        // GUARDAR TIMESTAMP PARA BLOQUEO
        localStorage.setItem("bio_nombre", nombre);
        localStorage.setItem("bio_grupo", grupo);
        localStorage.setItem("bio_ultimo_tiempo", Date.now()); // <--- ESTO ES EL CANDADO
        localStorage.setItem("bio_fecha_ticket", `${fechaTxt} - ${horaTxt}`);

        // Bloquear bot√≥n visualmente
        btn.innerHTML = "‚è≥ Guardando...";
        btn.disabled = true;

        // ENVIAR
        const datos = { nombre: nombre, grupo: grupo, hora: horaTxt };
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        })
        .then(() => {
            generarTicket(nombre, grupo, `${fechaTxt} - ${horaTxt}`, "", false);
        })
        .catch(error => {
            alert("Internet lento, pero asistencia guardada localmente.");
            generarTicket(nombre, grupo, `${fechaTxt} - ${horaTxt}`, "", false);
        });
    }

    function generarTicket(nombre, grupo, fechaHora, idOpcional, esModoVista) {
        document.getElementById("pantallaFormulario").style.display = "none";
        document.getElementById("pantallaTicket").style.display = "block";
        
        document.getElementById("tNombre").innerText = nombre;
        document.getElementById("tGrupo").innerText = grupo;
        document.getElementById("tFecha").innerText = fechaHora;
        
        // Si es modo vista (bloqueado), usamos un ID gen√©rico o recuperado
        const idTicket = esModoVista ? "RE-PRINT" : "CLOUD-" + Math.floor(1000 + Math.random() * 9000);
        document.getElementById("tID").innerText = idTicket;

        // Limpiar QR anterior
        document.getElementById("qrTicket").innerHTML = "";
        
        new QRCode(document.getElementById("qrTicket"), {
            text: `VALIDADO|${nombre}|${fechaHora}`,
            width: 150, height: 150,
            colorDark : "#00274c",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    }
</script>

</body>
</html>





